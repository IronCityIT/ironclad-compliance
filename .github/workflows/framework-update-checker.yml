name: Framework Update Checker

on:
  schedule:
    # Quarterly: First day of Jan, Apr, Jul, Oct at midnight UTC
    - cron: '0 0 1 1,4,7,10 *'
  workflow_dispatch:
    inputs:
      framework:
        description: 'Specific framework to check (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - soc2
          - nist-csf
          - pci-dss
          - hipaa
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        type: boolean
        default: false

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      updates_found: ${{ steps.check.outputs.updates_found }}
      frameworks_updated: ${{ steps.check.outputs.frameworks_updated }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests beautifulsoup4

      - name: Check for framework updates
        id: check
        run: |
          python scripts/check_framework_updates.py \
            --framework "${{ inputs.framework }}" \
            --output updates.json
          
          if [ -f updates.json ]; then
            updates_found=$(jq -r '.updates_found' updates.json)
            frameworks=$(jq -r '.frameworks | join(",")' updates.json)
            echo "updates_found=$updates_found" >> $GITHUB_OUTPUT
            echo "frameworks_updated=$frameworks" >> $GITHUB_OUTPUT
          else
            echo "updates_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload check results
        uses: actions/upload-artifact@v4
        with:
          name: update-check-results
          path: updates.json
          retention-days: 30

  create-pr:
    needs: check-updates
    if: needs.check-updates.outputs.updates_found == 'true' || inputs.force_update == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download check results
        uses: actions/download-artifact@v4
        with:
          name: update-check-results

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Update compliance frameworks"
          title: "[Auto] Compliance Framework Updates Detected"
          body: |
            ## Framework Updates Detected
            
            This PR was automatically generated by the quarterly framework update checker.
            
            ### Frameworks Updated
            ${{ needs.check-updates.outputs.frameworks_updated }}
            
            ### Review Required
            - [ ] Verify control text accuracy
            - [ ] Check points of focus completeness
            - [ ] Validate cross-framework mappings
          branch: framework-updates-${{ github.run_number }}
          labels: |
            compliance
            auto-generated
